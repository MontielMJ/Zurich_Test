<div class="container">
  <div class="form-container">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>edit</mat-icon>
          Editar Póliza #{{ poliza?.folio?.value }}
        </mat-card-title>
        <mat-card-subtitle>Modifique la información de la póliza</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- Loading mientras carga la póliza -->
        <div *ngIf="isloadingPoliza" class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando información de la póliza...</p>
        </div>

        <!-- Formulario cuando ya cargó la póliza -->
        <form *ngIf="!isloadingPoliza" [formGroup]="polizaForm" (ngSubmit)="onSubmit()" class="poliza-form">
          
          <!-- Información de la Póliza -->
          <div class="poliza-info-section">
            <h4>Información de la Póliza</h4>
            <div class="poliza-details">
              <p><strong>ID:</strong> {{ poliza?.id }}</p>
              <p><strong>Estado actual:</strong> 
                <mat-chip [color]="estaVencida() ? 'warn' : (polizaForm.get('status')?.value ? 'primary' : 'warn')" selected>
                  {{ estaVencida() ? 'Vencida' : (polizaForm.get('status')?.value ? 'Activa' : 'Inactiva') }}
                </mat-chip>
              </p>
              <p *ngIf="estaVencida()" class="vencida-warning">
                <mat-icon>warning</mat-icon>
                Esta póliza está vencida
              </p>
            </div>
          </div>

          <!-- Folio -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Número de Folio</mat-label>
            <input 
              matInput 
              formControlName="folio" 
              placeholder="Ingrese el número de folio"
              type="number"
              min="1">
            <mat-icon matSuffix>numbers</mat-icon>
            
            <mat-error *ngIf="folio?.hasError('required')">
              El número de folio es requerido
            </mat-error>
            <mat-error *ngIf="folio?.hasError('min')">
              El folio debe ser mayor a 0
            </mat-error>
          </mat-form-field>

          <!-- Tipo de Póliza -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Tipo de Póliza</mat-label>
            <mat-select formControlName="idTypePolicy" placeholder="Seleccione el tipo de póliza">
              <mat-option *ngFor="let tipo of tiposPoliza" [value]="tipo">
                {{ tipo }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
            
            <mat-error *ngIf="idTypePolicy?.hasError('required')">
              El tipo de póliza es requerido
            </mat-error>
          </mat-form-field>

          <!-- Cliente -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Cliente</mat-label>
            <mat-select formControlName="idClient" placeholder="Seleccione el cliente">
              <mat-option *ngFor="let cliente of clientes" [value]="cliente.id!">
                {{ cliente.fullname }} - {{ cliente.identificationNumber }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
            
            <mat-error *ngIf="idClient?.hasError('required')">
              El cliente es requerido
            </mat-error>
          </mat-form-field>

          <!-- Fechas en fila para desktop -->
          <div class="date-row">
            <!-- Fecha de Inicio -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Fecha de Inicio</mat-label>
              <input 
                matInput 
                [matDatepicker]="inicioPicker" 
                formControlName="initDate"
                (dateChange)="onInitDateChange()"
                [min]="minDate"
                [max]="maxDate">
              <mat-datepicker-toggle matSuffix [for]="inicioPicker"></mat-datepicker-toggle>
              <mat-datepicker #inicioPicker></mat-datepicker>
              
              <mat-error *ngIf="initDate?.hasError('required')">
                La fecha de inicio es requerida
              </mat-error>
            </mat-form-field>

            <!-- Fecha de Fin -->
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Fecha de Fin</mat-label>
              <input 
                matInput 
                [matDatepicker]="finPicker" 
                formControlName="endDate"
                [min]="getMinEndDate()"
                [max]="maxDate">
              <mat-datepicker-toggle matSuffix [for]="finPicker"></mat-datepicker-toggle>
              <mat-datepicker #finPicker></mat-datepicker>
              
              <mat-error *ngIf="endDate?.hasError('required')">
                La fecha de fin es requerida
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Información de vigencia -->
          <div *ngIf="calcularDiasVigencia() > 0" class="vigencia-info">
            <p><strong>Días de vigencia:</strong> {{ calcularDiasVigencia() }} días</p>
            <p><strong>Período:</strong> 
              {{ getInitDateDisplay() }} 
              al 
              {{ getEndDateDisplay() }}
            </p>
          </div>

          <mat-error *ngIf="polizaForm.hasError('dateRangeInvalid')" class="full-width-error">
            La fecha de fin debe ser posterior a la fecha de inicio
          </mat-error>

          <!-- Monto Asegurado -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Monto Asegurado</mat-label>
            <input 
              matInput 
              formControlName="insuredAmount" 
              placeholder="Ingrese el monto asegurado"
              type="number"
              min="1000"
              step="0.01">
            <span matPrefix>$ &nbsp;</span>
            <mat-icon matSuffix>attach_money</mat-icon>
            
            <mat-error *ngIf="insuredAmount?.hasError('required')">
              El monto asegurado es requerido
            </mat-error>
            <mat-error *ngIf="insuredAmount?.hasError('min')">
              El monto mínimo es $1,000.00
            </mat-error>
            <mat-error *ngIf="insuredAmount?.hasError('max')">
              El monto máximo es $100,000,000.00
            </mat-error>
          </mat-form-field>

          <!-- Estado -->
          <mat-checkbox formControlName="status" class="full-width">
            Póliza Activa
          </mat-checkbox>
          <small class="hint">Si está desactivada, la póliza no tendrá cobertura</small>

        </form>
      </mat-card-content>

      <mat-card-actions *ngIf="!isloadingPoliza" align="end">
        <button 
          mat-button 
          type="button" 
          (click)="onCancel()"
          class="cancel-button"
          [disabled]="isLoading">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
        
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          (click)="onSubmit()"
          [disabled]="isLoading || polizaForm.invalid || polizaForm.pristine"
          class="submit-button">
          <mat-icon *ngIf="!isLoading">save</mat-icon>
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
          {{ isLoading ? 'Actualizando...' : 'Actualizar Póliza' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>